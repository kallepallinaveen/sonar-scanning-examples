pipeline{
    agent any
    stages{
        stage("checkout stage"){
            steps{

                git url ="https://github.com/kallepallinaveen/sonar-scanning-examples.git",branch="newsonar"

            }
        }
        stage("build a code"){
        steps{
            sh "mvn clean install"
             }
        }

        stage('Sonarqube Analysis') {
            environment {
              def scannerHome = tool 'SonarQubeScanner'
            }
            steps {  
                withSonarQubeEnv('sonarserver') {
                    dir('sonarqube-scanner-maven/maven-basic') {
                        sh "/opt/sonar/bin/sonar-scanner"
                        
                    }
                }
                sleep time: 30000, unit: 'MILLISECONDS'
                script {
                        def qg = waitForQualityGate()
                        if (qg.status != 'OK') {
                            error "Pipeline aborted due to quality gate failure: ${qg.status}"
                     }  
                }
            }
        }
        
    }
}